# Tower Wars - Game Design Document

## Overview

**Genre**: Real-time PvP Strategy with betting
**Style**: Galcon/Eufloria-like tower conquest
**Platform**: Mobile-first web game
**Players**: 2-4 per match

---

## Core Concept

Players compete to conquer all towers on the map. Each tower generates soldiers automatically. Players send troops from their towers to capture enemy or neutral towers. The last player standing wins the prize pool.

---

## Game Mechanics

### Towers
- All towers are identical (no types or levels)
- Towers generate soldiers at a fixed rate (except neutral towers)
- Neutral towers do not generate soldiers
- Each tower has a maximum soldier capacity

### Troops
- Players send a percentage of soldiers (25%, 50%, 75%, 100%) from one tower to another
- Troops travel in real-time toward destination
- When troops arrive:
  - **Friendly tower**: Soldiers are added
  - **Enemy/Neutral tower**: Soldiers fight (subtract)
  - **If defenders reach 0**: Tower is captured

### Controls (Mobile-First)

**Global % Slider** (always visible in UI):
- Slider with 4 steps: 25%, 50%, 75%, 100%
- Default: 50%
- Persists across all troop sends until changed

**Sending Troops**:
1. **Tap own tower**: Select as origin
2. **Tap another tower**: Send troops using current global %
3. **Tap empty area**: Deselect

This simplifies gameplay - no need to select % for each send. Change the slider once, send multiple times.

---

## Match Flow

```
┌─────────────────────────────────────────────────────────────┐
│                         LOBBY                                │
│  ┌─────────────────┐  ┌─────────────────┐                   │
│  │  Create Room    │  │   Join Room     │                   │
│  │  - Set buy-in   │  │  - Room list    │                   │
│  │  - 2-4 players  │  │  - Filter by $  │                   │
│  └────────┬────────┘  └────────┬────────┘                   │
└───────────┼────────────────────┼────────────────────────────┘
            │                    │
            ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│                      WAITING ROOM                            │
│  - Players list with ready status                           │
│  - Prize pool display                                        │
│  - Game starts when all players ready (min 2)               │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                         GAME                                 │
│  - Random balanced map generated by server                  │
│  - Each player starts with 1 tower (equal soldiers)         │
│  - Neutral towers distributed in center                     │
│  - Real-time simultaneous gameplay                          │
│  - Time limit: 10 minutes                                    │
└─────────────────────────┬───────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      GAME OVER                               │
│  - Winner: last player standing OR most soldiers at timeout │
│  - Prize distribution                                        │
│  - Return to lobby                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## Victory Conditions

| Condition | Winner |
|-----------|--------|
| **Conquest** | Last player with towers wins |
| **Timeout (10 min)** | Player with most total soldiers wins |
| **Tie (same soldiers)** | Player with more towers wins |

---

## Betting & Prize Distribution

### Room Creation
- Creator sets buy-in amount
- **Buy-in range**: 10 - 10,000 coins
- All players pay equal buy-in to join

### Prize Pool Distribution

**Standard (70/30 split):**
- 1st place: 70% of pool
- 2nd place: 30% of pool

### Player States

| State | Description | Payout |
|-------|-------------|--------|
| **Winner** | Last standing or most soldiers | 70% of pool |
| **Runner-up** | Second place | 30% of pool |
| **Eliminated** | All towers conquered | 0% (loses bet) |
| **Disconnected** | 30s+ without connection | 25% refund, towers become neutral |
| **Forfeit** | Voluntary quit during game | 0% (loses bet) |

### Example: 4 Players × 100 coins = 400 pool

| Event | Pool | Notes |
|-------|------|-------|
| Game starts | 400 | All players active |
| Player A eliminated | 400 | A loses everything |
| Player B disconnects | 375 | B gets 25 back, 75 stays in pool |
| Timeout: C has 150 soldiers, D has 120 | - | C wins by soldier count |

**Final payout:**
- Player A: 0 (eliminated)
- Player B: 25 (disconnected refund)
- Player C: 262 (1st - 70% of 375)
- Player D: 113 (2nd - 30% of 375)

---

## Map Generation

### Layout
- **Total towers**: 6-8 per match
- **Distribution**:
  - 1 tower per player (starting positions)
  - Remaining towers are neutral
- **Positions**: Balanced grid with random variation
- **Symmetry**: Equidistant starting positions for fairness

### Initial Soldiers
- **Player towers**: 10 soldiers
- **Neutral towers**: 5-15 soldiers (random)

---

## Visual Design (MVP)

### Towers
- **Player**: Colored circle (unique color per player)
- **Neutral**: Gray circle (#95a5a6)
- **Selected**: Thicker border
- **Soldier count**: White number in center

### Troops
- Small circle matching team color
- Moves in straight line toward destination
- Small number showing troop size

### Links
- Line connecting origin to destination during troop movement
- Color matches sending team

### Color Palette
| Element | Color |
|---------|-------|
| Player 1 | #3498db (Blue) |
| Player 2 | #e74c3c (Red) |
| Player 3 | #2ecc71 (Green) |
| Player 4 | #f39c12 (Orange) |
| Neutral | #95a5a6 (Gray) |

---

## Technical Architecture

### Services

| Service | Responsibility |
|---------|----------------|
| **game-client** | Phaser game rendering, player input |
| **web-portal** | React UI, lobby, room management |
| **game-server** | Authoritative game state, WebSocket sync |
| **cashier** | Wallet, bets, payouts |

### Cashier API (Mocked for MVP)

```typescript
// Endpoints
POST /api/cashier/balance     // Get user balance
POST /api/cashier/deposit     // Add funds
POST /api/cashier/withdraw    // Withdraw funds
POST /api/cashier/bet         // Lock funds for game
POST /api/cashier/payout      // Distribute winnings
POST /api/cashier/refund      // Partial refund (disconnect)
```

### Game State Sync
- Server is authoritative (prevents cheating)
- WebSocket for real-time updates
- Client predicts locally, server validates

---

## Entities

### Tower
```typescript
interface Tower {
  id: string;
  position: { x: number; y: number };
  owner: string | null;  // null = neutral
  soldiers: number;
  generationRate: number;  // soldiers per second (0 for neutral)
  maxSoldiers: number;
}
```

### Troop
```typescript
interface Troop {
  id: string;
  owner: string;
  origin: string;      // tower id
  destination: string; // tower id
  soldiers: number;
  position: { x: number; y: number };
  speed: number;
}
```

### Player
```typescript
interface Player {
  id: string;
  username: string;
  color: string;
  status: 'active' | 'eliminated' | 'disconnected';
  bet: number;
}
```

### Room
```typescript
interface Room {
  id: string;
  creator: string;
  buyIn: number;
  maxPlayers: number;
  players: Player[];
  status: 'waiting' | 'playing' | 'finished';
}
```

---

## Game Constants

```typescript
const GAME_CONFIG = {
  // Time
  MATCH_DURATION_MS: 10 * 60 * 1000,  // 10 minutes
  DISCONNECT_TIMEOUT_MS: 30 * 1000,   // 30 seconds

  // Towers
  SOLDIER_GENERATION_RATE: 1,         // per second
  MAX_SOLDIERS_PER_TOWER: 100,
  STARTING_SOLDIERS: 10,

  // Troops
  TROOP_SPEED: 100,                   // pixels per second
  SEND_PERCENTAGES: [25, 50, 75, 100],

  // Betting
  MIN_BUY_IN: 10,
  MAX_BUY_IN: 10000,
  WINNER_SHARE: 0.70,
  RUNNER_UP_SHARE: 0.30,
  DISCONNECT_REFUND: 0.25,

  // Players
  MIN_PLAYERS: 2,
  MAX_PLAYERS: 4,
};
```

---

## Implementation Phases

### Phase 1: Single-Player Prototype
- [ ] Tower entity with rendering and generation
- [ ] Troop entity with movement
- [ ] Selection and sending mechanics
- [ ] Victory condition (conquer all)
- [ ] Random map generation

### Phase 2: Multiplayer Foundation
- [ ] WebSocket connection
- [ ] Room creation and joining
- [ ] Game state synchronization
- [ ] Multiple player colors

### Phase 3: Betting System
- [ ] Cashier mock API
- [ ] Buy-in flow
- [ ] Prize distribution
- [ ] Disconnect handling

### Phase 4: Polish
- [ ] Visual feedback (animations)
- [ ] Sound effects
- [ ] Leaderboards
- [ ] Mobile optimization
